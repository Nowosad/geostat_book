
# Estymacje jednozmienne {#estymacje-jednozmienne}

Odtworzenie obliczeń z tego rozdziału wymaga załączenia poniższych pakietów oraz wczytania poniższych danych:

```{r 08-estymacje-1, message=FALSE, warning=FALSE}
library(sf)
library(stars)
library(gstat)
library(geostatbook)
data(punkty)
data(siatka)
paleta = hcl.colors(40, palette = "ag_Sunset")
```

```{r 08-estymacje-2, echo=FALSE}
par(mar = c(rep(0, 4)))
```

## Kriging

### Interpolacja geostatystyczna

Kriging (interpolacja geostatystyczna) to grupa metod estymacji zaproponowana w latach 50. przez Daniela Krige.
Główna zasada mówi, że prognoza w danej lokalizacji jest kombinacją obokległych obserwacji. 
Waga nadawana każdej z obserwacji jest zależna od stopnia (przestrzennej) korelacji - stąd też bierze się istotna rola semiwariogramów.

### Metod krigingu

Istnieje szereg meteod krigingu, w tym:

- Kriging prosty (ang. *Simple kriging*)
- Kriging zwykły (ang. *Ordinary kriging*)
- Kriging z trendem (ang. *Kriging with a trend*)
- Kriging danych kodowanych (ang. *Indicator kriging*)
- Kriging stratyfikowany (ang. *Kriging within strata* – KWS)
- Kriging prosty ze zmiennymi średnimi lokalnymi (ang. *Simple kriging with varying local means* - SKlm)
- Kriging z zewnętrznym trendem/Uniwersalny kriging (ang.*Kriging with an external trend/Universal kriging*)
- Kokriging (ang. *Co-kriging*)
- Kriging danych kodowanych (ang. *Indicator kriging*)
- Inne

## Kriging prosty

### Kriging prosty (ang. *Simple kriging*)

Kriging prosty zakłada, że średnia jest znana i stała na całym obszarze.
W poniższym przykładzie po stworzeniu semiwariogramu empirycznego, dopasowano model semiwariogramu składający się z funkcji sferycznej o zasięgu 4000 metrów i wartości nuggetu równej 0,5 (rycina \@ref(fig:08-estymacje-3)).

```{r 08-estymacje-3, fig.cap="Model złożony z modelu nuggetowego i sferycznego dla zmiennej temp."}
vario = variogram(temp~1, locations = punkty)
model = vgm(10, model = "Sph", range = 4000, nugget = 0.5)
model
plot(vario, model = model)
```

```{r 08-estymacje-4}
# fitted = fit.variogram(vario, model)
```

Następnie nastąpiła estymacja wartości z użyciem metody kriginu prostego. 
W funkcji `krige()` z pakietu **gstat**, użycie tej metody wymaga ustalenia średniej wartości cechy za pomocą argumentu `beta`. 

```{r 08-estymacje-5 }
mean(punkty$temp)
```

```{r 08-estymacje-6}
sk = krige(temp~1, 
            locations = punkty,
            newdata = siatka,
            model = model,
            beta = 16)
```

Wynik krigingu prostego, jak i każdy inny uzyskany z użyciem pakietu **gstat**, można podejrzeć używając funkcji `summary()`.
Szczególnie ważne są dwie, nowe zmienne - `var1.pred` oraz `var1.var`.
Pierwsza z nich oznacza wartość estymowaną dla każdego oczka siatki, druga zaś mówi o wariancji estymacji. 

```{r 08-estymacje-7}
sk
```

Obie uzyskane zmienne można wyświetlić z użyciem funkcji `plot()` (rycina \@ref(fig:plotsy2)).

```{r plotsy1, eval=FALSE}
plot(sk["var1.pred"], col = paleta)
plot(sk["var1.var"], col = paleta)
```

```{r plotsy2, echo=FALSE, eval=TRUE, fig.height=8, fig.cap = "Estymacja i wariancja estymacji używając metody krigingu prostego (SK)."}
library(gridExtra)
p1 = p1_base + geom_stars(data = sk["var1.pred"]) +
        ggtitle("Estymacja SK")
p2 = p1_base + geom_stars(data = sk["var1.var"]) + 
        ggtitle("Wariancja estymacji SK")
grid.arrange(p1, p2, ncol = 1)
```

## Kriging zwykły 

### Kriging zwykły (ang. *Ordinary kriging*)

W krigingu zwykłym średnia traktowana jest jako wartość nieznana. 
Metoda ta uwzględnia lokalne fluktuacje średniej poprzez stosowanie ruchomego okna. 
Parametry ruchomego okna można określić za pomocą jednego z dwóch argumentów:

- `nmax` - użyta zostanie określona liczba najbliższych obserwacji.
- `maxdist` - użyte zostaną jedynie obserwacje w zadanej odległości.

```{r 08-estymacje-8 }
# ok = krige(temp~1,
#             locations = punkty,
#             newdata = siatka, 
#             model = model, 
#             nmax = 30)
ok = krige(temp~1,
            locations = punkty,
            newdata = siatka, 
            model = model, 
            maxdist = 1500)
```

Podobnie jak w przypadku krigingu prostego, można przyjrzeć się wynikom estymacji używając funkcji `summary()` oraz wyświetlić je używając funkcji `plot()` (rycina \@ref(fig:plotsy2ok2)).

```{r 08-estymacje-9}
ok
```

```{r plotsy1ok2, eval=FALSE}
plot(ok["var1.pred"], col = paleta)
plot(ok["var1.var"], col = paleta)
```

```{r plotsy2ok2, echo=FALSE, eval=TRUE, fig.height=8, fig.cap = "Estymacja i wariancja estymacji używając metody krigingu zwykłego (OK)."}
library(gridExtra)
p1 = p1_base + geom_stars(data = ok["var1.pred"]) +
        ggtitle("Estymacja OK")
p2 = p1_base + geom_stars(data = ok["var1.var"]) + 
        ggtitle("Wariancja estymacji OK")
grid.arrange(p1, p2, ncol = 1)
```

<!--
```{r , include=FALSE, eval=FALSE}
spplot(ok, "var1.pred", sp.layout = list(as(punkty, "Spatial"), pch = 21, col = "white"))
spplot(ok, "var1.var", sp.layout = list(as(punkty, "Spatial"), pch = 21, col = "white"))
```
-->

## Kriging z trendem

### Kriging z trendem (ang. *Kriging with a trend*)

Kriging z trendem, określany również jako kriging z wewnętrznym trendem, do estymacji wykorzystuje (oprócz zmienności wartości wraz z odległością) położenie analizowanych punktów.
W pierwszym kroku konieczne jest dodanie współrzęnych do używanego obiektu i do używanej siatki.

```{r 08-estymacje-10}
# dodanie współrzędnych do punktów
punkty$x = st_coordinates(punkty)[, 1]
punkty$y = st_coordinates(punkty)[, 2]
# dodanie współrzędnych do siatki
siatka$x = st_coordinates(siatka)[, 1]
siatka$y = st_coordinates(siatka)[, 2]
```

Następnie pierwszy z argumentów w funkcji `variogram()` musi przyjąć postać `temp ~ x + y`, co oznacza, że uwzględniamy liniowy trend zależny od współrzędnej `x` oraz `y` (rycina \@ref(fig:08-estymacje-11)).

```{r 08-estymacje-11, fig.cap="Semiwariogram zmiennej temp uwzględniający współrzędne x i y."}
vario_kzt = variogram(temp ~ x + y, locations = punkty)
plot(vario_kzt)
```

Dalszym etapem jest dopasowanie modelu semiwariancji, a następnie wyliczenie estymowanych wartości z użyciem funkcji `krige()`.
Należy tutaj pamiętać, aby wzór (w przykładzie `temp ~ x + y`) był taki sam podczas budowania semiwariogramu, jak i estymacji (rycina \@ref(fig:08-estymacje-12)).

```{r 08-estymacje-12, fig.cap="Model semiwariogramu zmiennej temp uwzględniający współrzędne x i y."}
model_kzt = vgm(model = "Sph", nugget = 1)
fitted_kzt = fit.variogram(vario_kzt, model_kzt)
fitted_kzt
plot(vario_kzt, fitted_kzt)
```

```{r 08-estymacje-13}
kzt = krige(temp ~ x + y, 
             locations = punkty, 
             newdata = siatka, 
             model = fitted_kzt)
```

```{r 08-estymacje-14}
kzt
```

```{r plotsy1kzt, eval=FALSE}
plot(kzt["var1.pred"], col = paleta)
plot(kzt["var1.var"], col = paleta)
```

```{r plotsy2kzt, echo=FALSE, eval=TRUE, fig.height=8, fig.cap = "Estymacja i wariancja estymacji używając metody krigingu z trendem (KZT)."}
library(gridExtra)
p1 = p1_base + geom_stars(data = kzt["var1.pred"]) +
        ggtitle("Estymacja KZT")
p2 = p1_base + geom_stars(data = kzt["var1.var"]) + 
        ggtitle("Wariancja estymacji KZT")
grid.arrange(p1, p2, ncol = 1)
```

## Porównanie wyników SK, OK i KZT

Poniższe porównanie krigingu prostego (SK), zwykłego (OK) i z trendem (KZT) wykazuje niewielkie różnice w uzyskanych wynikach (rycina \@ref(fig:ploty-trzy)).
W rozdziałach \@ref(estymacje-wielozmienne) oraz \@ref(wykorzystanie-do-estymacji-danych-uzupeniajacych) pokazane będą uzyskane wyniki interpolacji temperatury powietrza korzystając z innych metod krigingu.

```{r ploty-trzy, echo=FALSE, message=FALSE, fig.asp=0.25, fig.cap="Porównanie wyników estymacji używając metody krigingu prostego (SK), krigingu zwykłego (OK) i krigingu z trendem (KZT)."}
est = c(sk, ok, kzt)
est = est[c(1, 3, 5)]
names(est) = c("Estymacja SK", "Estymacja OK", "Estymacja KZT")
est = st_redimension(est)

p1_base + 
        geom_stars(data = est) + 
        facet_wrap(~new_dim)
```

## Zadania {#z8}

Zadania w tym rozdziale są oparte o dane z obiektu `punkty_pref`.
Możesz go wczytać używając poniższego kodu:

```{r 08-estymacje-15}
data(punkty_pref)
```

Na jego podstawie stwórz trzy obiekty - `punkty_pref1` zawierający wszystkie punkty, `punkty_pref2` zawierający losowe 100 punktów, oraz `punkty_pref3` zawierający losowe 30 punktów.

```{r 08-estymacje-16}
set.seed(2018-11-25)
punkty_pref1 = punkty_pref
punkty_pref2 = punkty_pref[sample(nrow(punkty_pref), 100), ]
punkty_pref3 = punkty_pref[sample(nrow(punkty_pref), 30), ]
```

1. Zbuduj optymalne modele semiwariogramu zmiennej `srtm` dla trzech zbiorów danych - `punkty_pref1`, `punkty_pref2`, `punkty_pref3`.
Porównaj graficznie uzyskane modele.
2. W oparciu o uzyskane modele stwórz estymacje zmiennej `srtm` dla trzech zbiorów danych - `punkty_pref1`, `punkty_pref2`, `punkty_pref3` używając krigingu prostego.
Porównaj graficznie zarówno mapy estymacji jak i mapy wariancji. 
Opisz zaobserwowane różnice.
3. W oparciu o uzyskane modele stwórz estymacje zmiennej `srtm` dla zbioru danych `punkty_pref3` używając krigingu zwykłego.
Sprawdź jak wygląda wynik estymacji uwzględniając (i) 10 najbliższych obserwacji, (ii) 30 najbliższych obserwacji, (iii) obserwacje w odległości do 2 km.
4. Używając krigingu z trendem, stwórz optymalne modele zmiennej `srtm` dla dwóch zbiorów danych - `punkty_pref1` oraz `punkty_pref3`.
5. Porównaj graficznie zarówno mapy estymacji jak i mapy wariancji dla krigingu prostego, zwykłego oraz z trendem dla danych `punkty_pref3`. 
Jakie można zauważyć podobieństwa a jakie różnice?
